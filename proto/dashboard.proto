syntax = "proto3";

package dashboard;
option go_package = "github.com/995933447/mconfigcenter-dashboard/backend/api/dashboard";

import "easymicro_ext.proto";
import "mgorm_ext.proto";
import "httpext.proto";

option (easymicro_ext.proto_gen_opts) = {
  server_package: "github.com/995933447/mconfigcenter-dashboard/backend/service/dashboardserver"
};

enum ErrCode {
  ErrCodeNil = 0;
  ErrCodeRSAKeysGenerating = 30001 [(easymicro_ext.err_message) = {message: "rsa key正在生成中"}];
  ErrCodeUserNotFound = 30002 [(easymicro_ext.err_message) = {message: "用户不存在"}];
  ErrCodePasswordIncorrect = 30003 [(easymicro_ext.err_message) = {message: "密码不正确"}];
}

service Dashboard {
  rpc GetRSAPubKey(GetRSAPubKeyReq) returns (GetRSAPubKeyResp) {
      option(httpext.http_rule) = {
        method: "POST"
        no_auth: true,
      };
  };

  rpc Login(LoginReq) returns (LoginResp) {
    option(httpext.http_rule) = {
      method: "POST"
      no_auth: true,
    };
  };

  rpc GetUserInfo(GetUserInfoReq) returns (GetUserInfoResp) {
    option(httpext.http_rule) = {
      method: "GET"
    };
  }

  rpc DisabledRBAC(DisabledRBACReq) returns (DisabledRBACResp) {
    option(httpext.http_rule) = {
      method: "GET"
    };
  }

  rpc AuthUser(AuthUserReq) returns (AuthUserResp);

  rpc ChangeUserPassword(ChangeUserPasswordReq) returns (ChangeUserPasswordResp) {
    option(httpext.http_rule) = {
      method: "POST"
    };
  };

  rpc ListMenuConf(ListMenuConfReq) returns (ListMenuConfResp) {
    option(httpext.http_rule) = {
      method: "GET"
    };
  }

  rpc AddMenuConf(AddMenuConfReq) returns (AddMenuConfResp) {
    option(httpext.http_rule) = {
      method: "POST"
    };
  }

  rpc UpdateMenuConf(UpdateMenuConfReq) returns (UpdateMenuConfResp) {
    option(httpext.http_rule) = {
      method: "POST"
    };
  }

  rpc DeleteMenuConf(DeleteMenuConfReq) returns (DeleteMenuConfResp) {
    option (httpext.http_rule) = {
      method: "POST"
    };
  }

  rpc ListRoleConf(ListRoleConfReq) returns (ListRoleConfResp) {
      option (httpext.http_rule) = {
        method: "GET"
      };
  };
}

message ListRoleConfReq {
  string name = 1;
  int32 status = 2;
  bool only_super_admin = 3;
  bool without_super_admin = 4;
}

message ListRoleConfResp {
  message Role {
    uint64 role_id = 1; // 角色id
    string name = 2; // 角色名称
    int32 status = 3; // 状态，参考enum RoleStatus
    repeated uint64 perm_ids = 4; // 权限id
    string remark = 5; // 备注
    bool is_super_admin = 6; // 是否超级管理员
  }

  repeated Role list = 1;
  uint32 total = 2;
}

message DeleteMenuConfReq {
  uint64 perm_id = 1;
}

message DeleteMenuConfResp {

}

message UpdateMenuConfReq {
  string name = 2; // 权限名称
  string path = 3;
  repeated string services = 4;
  uint64 pid = 5;
  uint64 perm_id = 6;
  int32 path_type = 7;
}

message UpdateMenuConfResp {

}

message AddMenuConfReq {
  string name = 2; // 权限名称
  string path = 3;
  repeated string services = 4;
  uint64 pid = 5;
  int32 path_type = 6;
}

message AddMenuConfResp {

}

message ListMenuConfReq {

}

message ListMenuConfResp {
  message MenuConf {
    uint64 perm_id = 1; // 权限id
    string name = 2; // 权限名称
    string path = 3;
    repeated string services = 4;
    uint64 pid = 5;
    int32 path_type = 6;
  }

  repeated MenuConf list = 1;
  uint32 total = 2;
}

message ChangeUserPasswordReq {
  string new_password = 1;
}

message ChangeUserPasswordResp {

}

message AuthUserReq {
  string token = 1;
}

message AuthUserResp {
  uint64 user_id = 1;
}

message DisabledRBACReq {

}

message DisabledRBACResp {
  bool disabled = 1;
}

message GetUserInfoReq {
}

message GetUserInfoResp {
  uint64 user_id = 1;
  string username = 2;
  repeated string role_names = 3;
  int64 last_login_at = 4;
}

message GetRSAPubKeyReq {

}

message GetRSAPubKeyResp {
  string key = 1;
}

message LoginReq {
  string username = 1;
  string password = 2;
}

message LoginResp {
  string token = 1;
  int64 expire_at = 2;
}

enum UserStatus {
  UserStatusNil = 0;
  UserStatusNormal = 1; // 正常状态
  UserStatusFrozen = 2; // 冻结状态
}

message User {
  option (mgorm_ext.mgorm_opts) = {
    conn: "default",
    db: "mconfigcenter_dashboard",
    tb: "user",
    cached: true,
    uniq_index_keys:["username", "user_id"]
  };
  string username = 1;
  string password = 2;
  uint32 status = 3;
  uint64 user_id = 4;
  int64 last_login_at = 5;
}